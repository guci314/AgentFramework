# 天气查询 MCP 工具使用说明

## 概述

本项目实现了一个完整的天气查询 MCP（Model Context Protocol）工具集，包括：

- **天气数据模块** (`weather_data.py`) - 提供模拟的天气数据和查询功能
- **MCP 服务器** (`weather_mcp_server.py`) - 标准的 MCP 服务器实现
- **简化演示** (`weather_mcp_demo.py`) - 展示核心功能的演示程序
- **Claude 集成** (`claude_weather_demo.py`) - 与 Claude Sonnet 的集成演示

## 快速开始

### 1. 运行简化演示

```bash
cd mcp_examples
python weather_mcp_demo.py
```

这将展示所有天气查询功能的基本用法。

### 2. 运行 Claude Sonnet 集成演示

首先设置环境变量：

```bash
# 在 .env 文件中设置
OPENROUTER_API_KEY=your_openrouter_api_key
```

然后运行：

```bash
python claude_weather_demo.py
```

## 支持的功能

### 🌡️ 当前天气查询
- **按城市名**: 支持中英文城市名（如：北京、Beijing、上海、Shanghai）
- **按坐标**: 根据经纬度获取天气信息

### 📊 天气预报
- **预报天数**: 1-7天
- **详细信息**: 高低温、天气状况、湿度、风速、降水量

### 🏙️ 城市管理
- **支持城市列表**: 查看所有支持的城市
- **坐标查询**: 根据城市名获取坐标信息

### 🌍 支持的城市

**中国城市**: 北京、上海、广州、深圳、杭州、成都、西安

**国际城市**: 伦敦、纽约、东京、巴黎、新加坡

## 工具接口

### get_current_weather
获取指定城市的当前天气信息

**参数**:
- `city` (string): 城市名称

**示例**:
```json
{
  "city": "北京"
}
```

### get_weather_by_coordinates
根据经纬度坐标获取天气信息

**参数**:
- `latitude` (number): 纬度（-90 到 90）
- `longitude` (number): 经度（-180 到 180）

**示例**:
```json
{
  "latitude": 39.9042,
  "longitude": 116.4074
}
```

### get_weather_forecast
获取指定城市的天气预报

**参数**:
- `city` (string): 城市名称
- `days` (integer, 可选): 预报天数（1-7天，默认5天）

**示例**:
```json
{
  "city": "上海",
  "days": 3
}
```

### get_supported_cities
获取支持查询天气的城市列表

**参数**: 无

## 技术架构

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   LLM Client    │───▶│   MCP Server     │───▶│  Weather Data   │
│ (Claude Sonnet) │    │                  │    │                 │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### 核心组件

1. **WeatherData 类** - 管理城市数据和天气生成
2. **MCP 服务器** - 处理工具调用和响应格式化
3. **Claude 代理** - 智能意图分析和自然语言交互

### 数据格式

天气信息包含：
- 基本信息：温度、体感温度、湿度、气压
- 天气状况：晴天、多云、雨、雪等（带 emoji 图标）
- 风力信息：风速、风向
- 环境数据：能见度、紫外线指数
- 空气质量：AQI、PM2.5、污染等级

## 扩展开发

### 添加新城市

在 `weather_data.py` 的 `cities` 字典中添加：

```python
"新城市名": (纬度, 经度, "时区"),
```

### 添加新工具

1. 在 `weather_mcp_server.py` 的 `list_tools()` 中定义工具
2. 在 `call_tool()` 中实现处理逻辑
3. 在 `claude_weather_demo.py` 中添加工具包装

### 自定义天气数据

修改 `WeatherData.generate_weather()` 方法来：
- 使用真实的天气 API
- 调整温度计算算法
- 添加更多天气参数

## 注意事项

1. **API 密钥**: Claude 集成需要 OpenRouter API 密钥
2. **网络代理**: 代码中包含代理设置（127.0.0.1:7890）
3. **模拟数据**: 当前使用模拟天气数据，非真实数据
4. **城市支持**: 仅支持预定义的城市列表

## 故障排除

### 常见问题

1. **城市不支持**: 检查城市名是否在支持列表中
2. **坐标超范围**: 确保纬度在 -90 到 90，经度在 -180 到 180
3. **API 调用失败**: 检查网络连接和 API 密钥设置

### 错误码

- `ValueError`: 城市名不在支持列表中
- `坐标超出有效范围`: 坐标参数不合法
- `服务器内部错误`: 意外的系统错误

## 示例对话

### 用户
"北京今天天气怎么样？"

### 助手
🌤️ **北京 天气报告**

📅 **当前时间**: 2025-07-06 21:18:39
🌡️ **温度**: -8.9°C (体感温度: -11.4°C)
🌫️ **天气**: 雾
💧 **湿度**: 89%
🌪️ **风速**: 7.0 km/h (西南风)
👁️ **能见度**: 9.4 km
☀️ **紫外线指数**: 10
🏭 **空气质量**: 重度污染 (AQI: 134)

根据当前天气情况，建议您：
- 外出时佩戴口罩，空气质量较差
- 雾天能见度低，驾车请减速慢行
- 温度较低，注意保暖

---

这个天气查询 MCP 工具演示了如何构建一个完整的 AI 工具生态系统，从数据层到服务层再到智能交互层的完整实现。