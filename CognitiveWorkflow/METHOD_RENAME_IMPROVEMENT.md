# æ–¹æ³•é‡å‘½åæ”¹è¿›ï¼šprocess_single_iteration â†’ select_rule

## æ¦‚è¿°

å°† `RuleEngineService.process_single_iteration` æ–¹æ³•é‡å‘½åä¸º `select_rule`ï¼Œä»¥æ›´å‡†ç¡®åœ°åæ˜ è¯¥æ–¹æ³•çš„å®é™…åŠŸèƒ½ã€‚

## é—®é¢˜åˆ†æ

### åŸæ–¹æ³•åçš„é—®é¢˜
- **`process_single_iteration`**: æš—ç¤ºå¤„ç†æ•´ä¸ªè¿­ä»£è¿‡ç¨‹
- **è¯¯å¯¼æ€§**: è®©äººä»¥ä¸ºè¯¥æ–¹æ³•æ‰§è¡Œå®Œæ•´çš„è¿­ä»£å¾ªç¯
- **ä¸å‡†ç¡®**: å®é™…ä¸Šåªè´Ÿè´£è§„åˆ™é€‰æ‹©ï¼Œä¸æ¶‰åŠæ‰§è¡Œ

### å®é™…åŠŸèƒ½
æŸ¥çœ‹æ–¹æ³•å®ç°ï¼Œè¯¥æ–¹æ³•çš„æ ¸å¿ƒèŒè´£æ˜¯ï¼š
1. æŸ¥æ‰¾é€‚ç”¨çš„è§„åˆ™ (`find_applicable_rules`)
2. é€‰æ‹©æœ€ä½³è§„åˆ™ (`select_best_rule`) 
3. è¿”å›å†³ç­–ç»“æœ (`DecisionResult`)

## æ”¹è¿›è¯¦æƒ…

### æ–¹æ³•ç­¾åæ›´æ–°
```python
# åŸæ–¹æ³•å
def process_single_iteration(self, 
                           global_state: GlobalState, 
                           rule_set: RuleSet) -> DecisionResult:

# æ–°æ–¹æ³•å  
def select_rule(self, 
               global_state: GlobalState, 
               rule_set: RuleSet) -> DecisionResult:
```

### æ–‡æ¡£å­—ç¬¦ä¸²æ›´æ–°
```python
# åŸæ–‡æ¡£
"""
å¤„ç†å•æ¬¡è¿­ä»£å¾ªç¯

Args:
    global_state: å½“å‰å…¨å±€çŠ¶æ€
    rule_set: è§„åˆ™é›†
    
Returns:
    DecisionResult: è¿­ä»£å†³ç­–ç»“æœ
"""

# æ–°æ–‡æ¡£
"""
é€‰æ‹©é€‚åˆå½“å‰çŠ¶æ€çš„è§„åˆ™

Args:
    global_state: å½“å‰å…¨å±€çŠ¶æ€
    rule_set: è§„åˆ™é›†
    
Returns:
    DecisionResult: è§„åˆ™é€‰æ‹©å†³ç­–ç»“æœ
"""
```

### æ—¥å¿—ä¿¡æ¯æ›´æ–°
```python
# åŸæ—¥å¿—
logger.debug("å¤„ç†å•æ¬¡è¿­ä»£å¾ªç¯")
logger.debug(f"è¿­ä»£å†³ç­–: {decision.decision_type.value}")
logger.error(f"å•æ¬¡è¿­ä»£å¤„ç†å¤±è´¥: {e}")

# æ–°æ—¥å¿—
logger.debug("å¼€å§‹è§„åˆ™é€‰æ‹©è¿‡ç¨‹")
logger.debug(f"è§„åˆ™é€‰æ‹©å†³ç­–: {decision.decision_type.value}")
logger.error(f"è§„åˆ™é€‰æ‹©å¤±è´¥: {e}")
```

### è°ƒç”¨ç‚¹æ›´æ–°
```python
# åŸè°ƒç”¨
# å¤„ç†å•æ¬¡è¿­ä»£
decision = self.process_single_iteration(global_state, rule_set)

# æ–°è°ƒç”¨
# é€‰æ‹©è¦æ‰§è¡Œçš„è§„åˆ™
decision = self.select_rule(global_state, rule_set)
```

## æ–¹æ³•èŒè´£æ›´åŠ æ˜ç¡®

### é‡å‘½ååçš„èŒè´£è¾¹ç•Œ
- **`select_rule`**: è´Ÿè´£è§„åˆ™é€‰æ‹©å†³ç­–
- **æ‰§è¡Œé€»è¾‘**: ç”±è°ƒç”¨æ–¹çš„è¿­ä»£å¾ªç¯è´Ÿè´£
- **çŠ¶æ€æ›´æ–°**: ç”±å…¶ä»–ä¸“é—¨çš„æ–¹æ³•è´Ÿè´£

### è°ƒç”¨ä¸Šä¸‹æ–‡
```python
while iteration_count < self.max_iterations and not goal_achieved:
    iteration_count += 1
    logger.info(f"å¼€å§‹ç¬¬ {iteration_count} æ¬¡è¿­ä»£")
    
    # ğŸ¯ è§„åˆ™é€‰æ‹©ï¼ˆä¸“æ³¨å•ä¸€èŒè´£ï¼‰
    decision = self.select_rule(global_state, rule_set)
    
    # åç»­çš„æ‰§è¡Œã€çŠ¶æ€æ›´æ–°ç­‰ç”±å…¶ä»–ä»£ç è´Ÿè´£
    if decision.decision_type == DecisionType.EXECUTE_SELECTED_RULE:
        rule_execution = self.rule_execution.execute_rule(...)
        # ...
```

## ä»£ç å¯è¯»æ€§æå‡

### æ›´æ¸…æ™°çš„æ–¹æ³•å‘½å
- **ä¸€ç›®äº†ç„¶**: `select_rule` ç«‹å³ä¼ è¾¾æ–¹æ³•ç”¨é€”
- **åŠ¨è¯æ˜ç¡®**: "é€‰æ‹©"æ¯”"å¤„ç†"æ›´å…·ä½“
- **é¢†åŸŸè¯­è¨€**: ç¬¦åˆè§„åˆ™å¼•æ“çš„æœ¯è¯­

### æ›´å¥½çš„ä»£ç æµç¨‹ç†è§£
```python
# ç°åœ¨çš„ä»£ç æµç¨‹æ›´åŠ æ¸…æ™°
decision = self.select_rule(global_state, rule_set)  # é€‰æ‹©è§„åˆ™
if decision.decision_type == DecisionType.EXECUTE_SELECTED_RULE:
    execution = self.rule_execution.execute_rule(...)  # æ‰§è¡Œè§„åˆ™
    global_state = self.state_service.update_state(...)  # æ›´æ–°çŠ¶æ€
```

## ç»´æŠ¤ä¼˜åŠ¿

1. **é™ä½è®¤çŸ¥è´Ÿæ‹…**: æ–°å¼€å‘è€…æ›´å®¹æ˜“ç†è§£æ–¹æ³•ç”¨é€”
2. **å‡å°‘è¯¯ç”¨**: æ–¹æ³•åå‡†ç¡®ä¼ è¾¾åŠŸèƒ½è¾¹ç•Œ
3. **ä¾¿äºé‡æ„**: èŒè´£æ¸…æ™°çš„æ–¹æ³•æ›´å®¹æ˜“ä¿®æ”¹å’Œæ‰©å±•
4. **ä»£ç è‡ªæ–‡æ¡£**: æ–¹æ³•åæœ¬èº«å°±æ˜¯å¾ˆå¥½çš„æ–‡æ¡£

## å‘åå…¼å®¹æ€§

- **å†…éƒ¨é‡æ„**: è¿™æ˜¯å†…éƒ¨æ–¹æ³•é‡å‘½åï¼Œä¸å½±å“å…¬å…±API
- **æ— ç ´åæ€§**: ä¸å½±å“ç°æœ‰çš„å·¥ä½œæµä½¿ç”¨
- **æ—¥å¿—å‡çº§**: æ—¥å¿—ä¿¡æ¯æ›´å‡†ç¡®ï¼Œä¾¿äºè°ƒè¯•

## æ€»ç»“

è¿™ä¸ªé‡å‘½åæ”¹è¿›è™½ç„¶çœ‹èµ·æ¥ç®€å•ï¼Œä½†æ˜¾è‘—æå‡äº†ä»£ç çš„å¯è¯»æ€§å’Œç»´æŠ¤æ€§ï¼š

- âœ… **å‡†ç¡®æ€§**: æ–¹æ³•åå‡†ç¡®åæ˜ å®é™…åŠŸèƒ½
- âœ… **æ¸…æ™°æ€§**: èŒè´£è¾¹ç•Œæ›´åŠ æ˜ç¡®
- âœ… **ä¸€è‡´æ€§**: ä¸æ–¹æ³•å®é™…è¡Œä¸ºä¿æŒä¸€è‡´
- âœ… **å¯ç»´æŠ¤æ€§**: é™ä½äº†ä»£ç ç†è§£æˆæœ¬

è¿™ç§ç»†è‡´çš„å‘½åæ”¹è¿›ä½“ç°äº†å¯¹ä»£ç è´¨é‡çš„é‡è§†ï¼Œæœ‰åŠ©äºæ„å»ºæ›´æ¸…æ™°ã€æ›´æ˜“ç»´æŠ¤çš„ç³»ç»Ÿæ¶æ„ã€‚