# CognitiveWorkflow æœªå®ç°åŠŸèƒ½æ¸…å•

æœ¬æ–‡æ¡£è¯¦ç»†åˆ—å‡ºäº† CognitiveWorkflow æ¨¡å—ä¸­æ‰€æœ‰æœªå®ç°çš„åŠŸèƒ½ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åºï¼Œå¹¶æä¾›å…·ä½“çš„å®ç°å»ºè®®ã€‚

## ğŸ“‹ æ€»è§ˆ

- **æ€»è®¡æœªå®ç°åŠŸèƒ½**: 5ä¸ª
- **é«˜ä¼˜å…ˆçº§**: 1ä¸ª
- **ä¸­ä¼˜å…ˆçº§**: 4ä¸ª
- **ä½ä¼˜å…ˆçº§**: 0ä¸ª

---

## ğŸ”¥ é«˜ä¼˜å…ˆçº§ TODO

### 1. åŠ¨æ€ä»»åŠ¡æ·»åŠ  - è®¡åˆ’ä¿®æ­£çš„æ ¸å¿ƒåŠŸèƒ½
**ä½ç½®**: `CognitiveWorkflowEngine._apply_plan_modification()` æ–¹æ³•  
**æ–‡ä»¶**: `cognitive_workflow.py` ç¬¬1370è¡Œ  
**å½“å‰çŠ¶æ€**: ç©ºå®ç°ï¼ˆpassï¼‰

**åŠŸèƒ½æè¿°**:
å®ç°è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ æ–°ä»»åŠ¡çš„èƒ½åŠ›ï¼Œè¿™æ˜¯è®¡åˆ’ä¿®æ­£æœºåˆ¶çš„æ ¸å¿ƒåŠŸèƒ½ã€‚

**éœ€è¦å®ç°**:
1. è§£æmodification_decisionä¸­çš„æ–°ä»»åŠ¡æ•°æ®
2. åˆ›å»ºCognitiveTaskå¯¹è±¡å¹¶æ·»åŠ åˆ°task_list
3. éªŒè¯æ–°ä»»åŠ¡çš„æœ‰æ•ˆæ€§ï¼ˆagentå­˜åœ¨ã€å…ˆå†³æ¡ä»¶åˆç†ç­‰ï¼‰
4. é‡æ–°è®¡ç®—ä»»åŠ¡IDä»¥é¿å…å†²çª
5. è®°å½•ä»»åŠ¡æ·»åŠ çš„å®¡è®¡æ—¥å¿—

**ç¤ºä¾‹å®ç°**:
```python
new_tasks_data = modification_decision.get('details', {}).get('new_tasks', [])
for task_data in new_tasks_data:
    new_task = CognitiveTask(
        id=f"dynamic_{len(self.task_list)+1}",
        name=task_data['name'],
        instruction=task_data['instruction'],
        agent_name=task_data['agent_name'],
        instruction_type=task_data['instruction_type'],
        phase=TaskPhase(task_data['phase']),
        expected_output=task_data['expected_output'],
        precondition=task_data['precondition']
    )
    self.task_list.append(new_task)
    logger.info(f"æ·»åŠ æ–°ä»»åŠ¡: {new_task.id}")
```

**å½±å“èŒƒå›´**: å½±å“å·¥ä½œæµçš„åŠ¨æ€é€‚åº”èƒ½åŠ›ï¼Œæ˜¯å®ç°çœŸæ­£æ™ºèƒ½å·¥ä½œæµçš„å…³é”®

---

## âš¡ ä¸­ä¼˜å…ˆçº§ TODO

### 2. æ™ºèƒ½ä¿®å¤ä»»åŠ¡è§£æ - å®Œå–„ä¿®å¤ä»»åŠ¡ç”Ÿæˆ
**ä½ç½®**: `CognitivePlanner.generate_recovery_tasks()` æ–¹æ³•  
**æ–‡ä»¶**: `cognitive_workflow.py` ç¬¬619è¡Œ  
**å½“å‰çŠ¶æ€**: ç®€åŒ–å®ç°ï¼Œåªç”ŸæˆåŸºæœ¬é‡è¯•ä»»åŠ¡

**åŠŸèƒ½æè¿°**:
å°†å½“å‰çš„ç®€å•é‡è¯•æœºåˆ¶å‡çº§ä¸ºæ™ºèƒ½ä¿®å¤ä»»åŠ¡ç”Ÿæˆç³»ç»Ÿã€‚

**éœ€è¦å®ç°**:
1. è§£æLLMè¿”å›çš„JSONæ ¼å¼ä¿®å¤ä»»åŠ¡åˆ—è¡¨
2. æ”¯æŒå¤šç§ä¿®å¤ç­–ç•¥ï¼šå‚æ•°è°ƒæ•´ã€ç¯å¢ƒä¿®å¤ã€ä¾èµ–å®‰è£…ç­‰
3. æ ¹æ®é”™è¯¯ç±»å‹ç”Ÿæˆé’ˆå¯¹æ€§ä¿®å¤ä»»åŠ¡
4. æ”¯æŒä¿®å¤ä»»åŠ¡é“¾ï¼šä¿®å¤A â†’ ä¿®å¤B â†’ é‡è¯•åŸä»»åŠ¡

**ç¤ºä¾‹å®ç°**:
```python
try:
    json_match = re.search(r'\{.*\}', result_text, re.DOTALL)
    if json_match:
        result_json = json.loads(json_match.group())
        recovery_tasks = []
        for task_data in result_json.get('recovery_tasks', []):
            recovery_task = CognitiveTask(
                id=task_data['id'],
                name=task_data['name'],
                instruction=task_data['instruction'],
                # ... å…¶ä»–å±æ€§
            )
            recovery_tasks.append(recovery_task)
        return recovery_tasks
except json.JSONDecodeError:
    logger.warning("ä¿®å¤ä»»åŠ¡JSONè§£æå¤±è´¥ï¼Œä½¿ç”¨ç®€å•é‡è¯•")
```

**å½±å“èŒƒå›´**: æå‡é”™è¯¯æ¢å¤èƒ½åŠ›ï¼Œå‡å°‘äººå·¥å¹²é¢„éœ€æ±‚

### 3. æ™ºèƒ½è¡¥å……ä»»åŠ¡ç”Ÿæˆ - å¢å¼ºå¤æ‚åœºæ™¯å¤„ç†èƒ½åŠ›
**ä½ç½®**: `CognitiveWorkflowEngine._handle_no_executable_tasks()` æ–¹æ³•  
**æ–‡ä»¶**: `cognitive_workflow.py` ç¬¬1350è¡Œ  
**å½“å‰çŠ¶æ€**: ä»…å¤„ç†å¤±è´¥ä»»åŠ¡çš„ä¿®å¤ï¼Œæ— æ³•ç”Ÿæˆæ–°çš„è¡¥å……ä»»åŠ¡

**åŠŸèƒ½æè¿°**:
å½“æ²¡æœ‰å¯æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œæ™ºèƒ½åˆ†æå¹¶ç”Ÿæˆå¿…è¦çš„è¡¥å……ä»»åŠ¡ã€‚

**éœ€è¦å®ç°**:
1. åŸºäºå½“å‰çŠ¶æ€å’ŒåŸå§‹ç›®æ ‡åˆ†æç¼ºå¤±çš„ä»»åŠ¡
2. æ£€æµ‹æ˜¯å¦éœ€è¦é¢å¤–çš„ä¿¡æ¯æ”¶é›†ä»»åŠ¡
3. ç”Ÿæˆå‰ç½®æ¡ä»¶å‡†å¤‡ä»»åŠ¡ï¼ˆå¦‚ç¯å¢ƒé…ç½®ã€ä¾èµ–å®‰è£…ï¼‰
4. æ”¯æŒç›®æ ‡ç»†åŒ–ï¼šå°†æ¨¡ç³Šç›®æ ‡åˆ†è§£ä¸ºå…·ä½“ä»»åŠ¡
5. æ™ºèƒ½ä»»åŠ¡æ¨èï¼šåŸºäºä¸Šä¸‹æ–‡å˜é‡æ¨èç›¸å…³ä»»åŠ¡

**ç¤ºä¾‹å®ç°**:
```python
if not failed_tasks and pending_tasks:
    # åˆ†æé˜»å¡åŸå› 
    blocked_analysis = self._analyze_blocked_tasks(pending_tasks)
    if blocked_analysis['needs_new_tasks']:
        new_tasks = self.planner.generate_supplementary_tasks(
            self.global_state.original_goal,
            blocked_analysis,
            self.global_state
        )
        if new_tasks:
            self.task_list.extend(new_tasks)
            return True
```

**å½±å“èŒƒå›´**: æå‡å·¥ä½œæµçš„è‡ªä¸»æ€§å’Œå®Œæ•´æ€§

### 4. åŠ¨æ€ä»»åŠ¡ç§»é™¤ - è®¡åˆ’ä¼˜åŒ–åŠŸèƒ½
**ä½ç½®**: `CognitiveWorkflowEngine._apply_plan_modification()` æ–¹æ³•  
**æ–‡ä»¶**: `cognitive_workflow.py` ç¬¬1390è¡Œ  
**å½“å‰çŠ¶æ€**: ç©ºå®ç°ï¼ˆpassï¼‰

**åŠŸèƒ½æè¿°**:
å®ç°è¿è¡Œæ—¶ç§»é™¤æ— æ•ˆæˆ–ä¸å¿…è¦ä»»åŠ¡çš„èƒ½åŠ›ã€‚

**éœ€è¦å®ç°**:
1. è§£æè¦ç§»é™¤çš„ä»»åŠ¡IDåˆ—è¡¨
2. æ£€æŸ¥ä»»åŠ¡ä¾èµ–å…³ç³»ï¼Œç¡®ä¿ç§»é™¤å®‰å…¨
3. æ›´æ–°ç›¸å…³ä»»åŠ¡çš„å…ˆå†³æ¡ä»¶
4. ä»task_listä¸­ç§»é™¤æŒ‡å®šä»»åŠ¡
5. è®°å½•ä»»åŠ¡ç§»é™¤çš„åŸå› å’Œå½±å“

**ç¤ºä¾‹å®ç°**:
```python
task_ids_to_remove = modification_decision.get('details', {}).get('task_ids', [])
for task_id in task_ids_to_remove:
    task_to_remove = next((t for t in self.task_list if t.id == task_id), None)
    if task_to_remove and task_to_remove.status == TaskStatus.PENDING:
        self.task_list.remove(task_to_remove)
        logger.info(f"ç§»é™¤ä»»åŠ¡: {task_id}")
```

**å½±å“èŒƒå›´**: æå‡è®¡åˆ’ä¼˜åŒ–èƒ½åŠ›ï¼Œé¿å…æ‰§è¡Œä¸å¿…è¦çš„ä»»åŠ¡

### 5. åŠ¨æ€ä»»åŠ¡ä¿®æ”¹ - è®¡åˆ’é€‚åº”åŠŸèƒ½
**ä½ç½®**: `CognitiveWorkflowEngine._apply_plan_modification()` æ–¹æ³•  
**æ–‡ä»¶**: `cognitive_workflow.py` ç¬¬1410è¡Œ  
**å½“å‰çŠ¶æ€**: ç©ºå®ç°ï¼ˆpassï¼‰

**åŠŸèƒ½æè¿°**:
å®ç°è¿è¡Œæ—¶ä¿®æ”¹ç°æœ‰ä»»åŠ¡å±æ€§çš„èƒ½åŠ›ã€‚

**éœ€è¦å®ç°**:
1. è§£æè¦ä¿®æ”¹çš„ä»»åŠ¡IDå’Œä¿®æ”¹å†…å®¹
2. æ”¯æŒä¿®æ”¹ä»»åŠ¡çš„æŒ‡ä»¤ã€å…ˆå†³æ¡ä»¶ã€é¢„æœŸè¾“å‡ºç­‰
3. éªŒè¯ä¿®æ”¹åçš„ä»»åŠ¡ä»ç„¶æœ‰æ•ˆ
4. æ›´æ–°ä»»åŠ¡çš„updated_atæ—¶é—´æˆ³
5. è®°å½•ä»»åŠ¡ä¿®æ”¹çš„å†å²ç‰ˆæœ¬

**ç¤ºä¾‹å®ç°**:
```python
modifications = modification_decision.get('details', {}).get('modifications', [])
for mod in modifications:
    task_id = mod['task_id']
    task = next((t for t in self.task_list if t.id == task_id), None)
    if task and task.status == TaskStatus.PENDING:
        if 'instruction' in mod:
            task.instruction = mod['instruction']
        if 'precondition' in mod:
            task.precondition = mod['precondition']
        task.updated_at = dt.now()
        logger.info(f"ä¿®æ”¹ä»»åŠ¡: {task_id}")
```

**å½±å“èŒƒå›´**: æå‡è®¡åˆ’é€‚åº”æ€§ï¼Œæ”¯æŒä»»åŠ¡çº§åˆ«çš„åŠ¨æ€è°ƒæ•´

---

## ğŸ› ï¸ å®ç°å»ºè®®

### å®ç°é¡ºåºæ¨è
1. **åŠ¨æ€ä»»åŠ¡æ·»åŠ ** (é«˜ä¼˜å…ˆçº§) - åŸºç¡€åŠŸèƒ½ï¼Œå…¶ä»–åŠŸèƒ½ä¾èµ–äºæ­¤
2. **æ™ºèƒ½ä¿®å¤ä»»åŠ¡è§£æ** (ä¸­ä¼˜å…ˆçº§) - æå‡é”™è¯¯æ¢å¤èƒ½åŠ›
3. **æ™ºèƒ½è¡¥å……ä»»åŠ¡ç”Ÿæˆ** (ä¸­ä¼˜å…ˆçº§) - å¢å¼ºè‡ªä¸»æ€§
4. **åŠ¨æ€ä»»åŠ¡ç§»é™¤** (ä¸­ä¼˜å…ˆçº§) - è®¡åˆ’ä¼˜åŒ–
5. **åŠ¨æ€ä»»åŠ¡ä¿®æ”¹** (ä¸­ä¼˜å…ˆçº§) - ç²¾ç»†è°ƒæ•´

### æŠ€æœ¯è€ƒè™‘
- æ‰€æœ‰åŠ¨æ€ä¿®æ”¹æ“ä½œéƒ½éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨
- ä»»åŠ¡IDç”Ÿæˆéœ€è¦é¿å…å†²çª
- ä¿®æ”¹æ“ä½œéœ€è¦å®Œæ•´çš„å®¡è®¡æ—¥å¿—
- éœ€è¦éªŒè¯ä¿®æ”¹åçš„ä»»åŠ¡åˆ—è¡¨ä»ç„¶é€»è¾‘ä¸€è‡´

### æµ‹è¯•ç­–ç•¥
- ä¸ºæ¯ä¸ªåŠŸèƒ½ç¼–å†™å•å…ƒæµ‹è¯•
- é›†æˆæµ‹è¯•éªŒè¯åŠ¨æ€ä¿®æ”¹ä¸ä¼šç ´åå·¥ä½œæµ
- æ€§èƒ½æµ‹è¯•ç¡®ä¿åŠ¨æ€æ“ä½œä¸å½±å“æ‰§è¡Œæ•ˆç‡

---

## ğŸ“Š å®ç°ä¼˜å…ˆçº§çŸ©é˜µ

| åŠŸèƒ½ | å¤æ‚åº¦ | å½±å“èŒƒå›´ | ç”¨æˆ·ä»·å€¼ | æ¨èä¼˜å…ˆçº§ |
|------|--------|----------|----------|------------|
| åŠ¨æ€ä»»åŠ¡æ·»åŠ  | ä¸­ | é«˜ | é«˜ | ğŸ”¥ é«˜ |
| æ™ºèƒ½ä¿®å¤ä»»åŠ¡è§£æ | ä¸­ | ä¸­ | é«˜ | âš¡ ä¸­ |
| æ™ºèƒ½è¡¥å……ä»»åŠ¡ç”Ÿæˆ | é«˜ | é«˜ | ä¸­ | âš¡ ä¸­ |
| åŠ¨æ€ä»»åŠ¡ç§»é™¤ | ä½ | ä¸­ | ä¸­ | âš¡ ä¸­ |
| åŠ¨æ€ä»»åŠ¡ä¿®æ”¹ | ä¸­ | ä¸­ | ä¸­ | âš¡ ä¸­ |

---

## ğŸ¯ å®Œæˆåçš„é¢„æœŸæ•ˆæœ

å®ç°æ‰€æœ‰TODOåï¼ŒCognitiveWorkflowå°†å…·å¤‡ï¼š

- **å®Œæ•´çš„åŠ¨æ€è®¡åˆ’ä¿®æ­£èƒ½åŠ›**: å¯åœ¨è¿è¡Œæ—¶æ·»åŠ ã€ç§»é™¤ã€ä¿®æ”¹ä»»åŠ¡
- **æ™ºèƒ½é”™è¯¯æ¢å¤æœºåˆ¶**: æ ¹æ®é”™è¯¯ç±»å‹ç”Ÿæˆé’ˆå¯¹æ€§ä¿®å¤ç­–ç•¥
- **è‡ªä¸»ä»»åŠ¡è¡¥å……èƒ½åŠ›**: æ£€æµ‹å¹¶ç”Ÿæˆç¼ºå¤±çš„å¿…è¦ä»»åŠ¡
- **çœŸæ­£çš„è®¤çŸ¥å·¥ä½œæµ**: å…·å¤‡è‡ªæˆ‘è°ƒæ•´å’Œä¼˜åŒ–çš„èƒ½åŠ›

è¿™å°†ä½¿CognitiveWorkflowæˆä¸ºä¸€ä¸ªçœŸæ­£æ™ºèƒ½çš„ã€è‡ªé€‚åº”çš„å·¥ä½œæµæ‰§è¡Œå¼•æ“ã€‚ 